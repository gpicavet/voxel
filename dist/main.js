(()=>{var r={835:function(r){r.exports=function(){"use strict";return r.importState=function(t){var e=new r;return e.importState(t),e},r;function r(){return function(r){var t=0,e=0,n=0,o=1;0==r.length&&(r=[+new Date]);var a=function(){var r=4022871197,t=function(t){t=t.toString();for(var e=0;e<t.length;e++){var n=.02519603282416938*(r+=t.charCodeAt(e));n-=r=n>>>0,r=(n*=r)>>>0,r+=4294967296*(n-=r)}return 2.3283064365386963e-10*(r>>>0)};return t.version="Mash 0.9",t}();t=a(" "),e=a(" "),n=a(" ");for(var i=0;i<r.length;i++)(t-=a(r[i]))<0&&(t+=1),(e-=a(r[i]))<0&&(e+=1),(n-=a(r[i]))<0&&(n+=1);a=null;var s=function(){var r=2091639*t+2.3283064365386963e-10*o;return t=e,e=n,n=r-(o=0|r)};return s.next=s,s.uint32=function(){return 4294967296*s()},s.fract53=function(){return s()+11102230246251565e-32*(2097152*s()|0)},s.version="Alea 0.9",s.args=r,s.exportState=function(){return[t,e,n,o]},s.importState=function(r){t=+r[0]||0,e=+r[1]||0,n=+r[2]||0,o=+r[3]||0},s}(Array.prototype.slice.call(arguments))}}()},144:r=>{r.exports="#version 300 es\nprecision highp float;\nprecision lowp usampler3D;\n\nuniform usampler3D terrainTex;\nuniform vec3 lightDir; // Direction de la lumière (normalisée)\nuniform vec3 terrainOffset; // offset pour la texture\nuniform vec3 terrainDim; // dim pour la texture\n\nin vec3 vColor;\nin vec3 vPosition;\n\nout vec4 fragColor;\n\nfloat castShadowRay(vec3 startPos, vec3 lightDir) {\n    int maxSteps = 200;\n    vec3 pos = startPos;\n    \n    // On avance pas à pas dans la direction de la lumière\n    for (int i = 0; i < maxSteps; i++) { \n        pos -= lightDir * 0.5; // Petit pas\n        // normalise la coord tex entre 0 et 1\n        vec3 stu = pos + terrainOffset;\n        stu = vec3(stu.x / terrainDim.x, stu.y / terrainDim.y, stu.z / terrainDim.z);\n        if (texture(terrainTex, stu).r > 0u) { // Si un voxel est rencontré\n            return 0.2; // Ombre \n        }\n    }\n    \n    return 1.0; // Pas d'obstruction = pas d'ombre\n}\n\nvoid main() {\n\n    float shadow = castShadowRay(vPosition,lightDir);\n\n    vec3 color = vColor * 0.2 + vColor * 0.8 * shadow;\n\n    fragColor = vec4(color, 1);\n}"},202:r=>{r.exports="#version 300 es\n\nlayout(std140, column_major) uniform;\n\nlayout(location=0) in vec4 position;\nlayout(location=1) in vec3 normal;\nlayout(location=2) in vec3 color;\n        \nuniform mat4 viewProj;\nuniform vec3 lightDir; // Direction de la lumière (normalisée)\n\nout vec3 vColor;\nout vec3 vPosition;\n\nvoid main() {\n    vColor = color * dot(normal, -lightDir);\n    //vColor = color;\n    vPosition = position.xyz;\n    gl_Position = viewProj * position;\n}"}},t={};function e(n){var o=t[n];if(void 0!==o)return o.exports;var a=t[n]={exports:{}};return r[n].call(a.exports,a,a.exports,e),a.exports}e.n=r=>{var t=r&&r.__esModule?()=>r.default:()=>r;return e.d(t,{a:t}),t},e.d=(r,t)=>{for(var n in t)e.o(t,n)&&!e.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:t[n]})},e.o=(r,t)=>Object.prototype.hasOwnProperty.call(r,t),(()=>{"use strict";var r=e(835),t=e.n(r),n=1e-6,o="undefined"!=typeof Float32Array?Float32Array:Array;function a(){var r=new o(3);return o!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function i(r,t,e){var n=new o(3);return n[0]=r,n[1]=t,n[2]=e,n}function s(r,t,e,n){return r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r[2]=t[2]+e[2]*n,r}function l(){var r=new o(16);return o!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var r=0,t=arguments.length;t--;)r+=arguments[t]*arguments[t];return Math.sqrt(r)}),a();const c=1/3,u=1/6,h=r=>0|Math.floor(r),v=new Float64Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);var f=e(202),m=e(144);let A=-2.7,d=-.7,E=i(200,200,200),T=null;function p(r){T=r.key}function x(r){T=null}class y{constructor(r,t){this.dim=r,this.pos=t,this.voxels=new Array(this.dim[0]),this.vertexArray=null,this.nElements=0}init(r){this.voxels=new Array(this.dim[0]);for(var t=0;t<this.dim[0];t++){this.voxels[t]=new Array(this.dim[1]);for(var e=0;e<this.dim[1];e++){this.voxels[t][e]=new Array(this.dim[2]);for(var n=0;n<this.dim[2];n++){var o=r(.01*(this.pos[0]+t),.01*(this.pos[1]+e),.01*(this.pos[2]+n));this.voxels[t][e][n]=0,(n+this.pos[2]==0||o<-.4)&&(this.voxels[t][e][n]=1)}}}}createArray(r){const t=[.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,-.5],e=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],n=[[0,1,2,3],[5,4,7,6],[4,5,1,0],[7,3,2,6],[1,5,6,2],[0,3,7,4]],o=[],a=[],i=[];for(var s=0;s<this.dim[0];s++)for(var l=0;l<this.dim[1];l++)for(var c=0;c<this.dim[2];c++)if(this.voxels[s][l][c]>0){const r=[];if(r[0]=s>=this.dim[0]-1||0==this.voxels[s+1][l][c],r[1]=s<=0||0==this.voxels[s-1][l][c],r[2]=l>=this.dim[1]-1||0==this.voxels[s][l+1][c],r[3]=l<=0||0==this.voxels[s][l-1][c],r[4]=c>=this.dim[2]-1||0==this.voxels[s][l][c+1],r[5]=c<=0||0==this.voxels[s][l][c-1],r[0]||r[1]||r[2]||r[3]||r[4]||r[5]){var u=s+this.pos[0],h=l+this.pos[1],v=c+this.pos[2];const x=[.1,1,.2];var f=[.5,.4,.3];v>30&&(f=[.5,.5,.5]);var m=c+1;(m>=this.dim[2]-1||0==this.voxels[s][l][m])&&(f=x);const y=[[[1,0,-1],[1,1,-1],[1,1,0],[1,1,1],[1,0,1],[1,-1,1],[1,-1,0],[1,-1,-1]],[[-1,0,-1],[-1,1,-1],[-1,1,0],[-1,1,1],[-1,0,1],[-1,-1,1],[-1,-1,0],[-1,-1,-1]],[[0,1,-1],[-1,1,-1],[-1,1,0],[-1,1,1],[0,1,1],[1,1,1],[1,1,0],[1,1,-1]],[[0,-1,-1],[-1,-1,-1],[-1,-1,0],[-1,-1,1],[0,-1,1],[1,-1,1],[1,-1,0],[1,-1,-1]],[[1,0,1],[1,1,1],[0,1,1],[-1,1,1],[-1,0,1],[-1,-1,1],[0,-1,1],[1,-1,1]],[[1,0,-1],[1,1,-1],[0,1,-1],[-1,1,-1],[-1,0,-1],[-1,-1,-1],[0,-1,-1],[1,-1,-1]]],g=[[0,1,2],[2,3,4],[4,5,6],[6,7,0]],_=r=>{const[t,e,n]=r;return(0==t||t<0&&s>0||t>0&&s<this.dim[0]-1)&&(0==e||e<0&&l>0||e>0&&l<this.dim[1]-1)&&(0==n||n<0&&c>0||n>0&&c<this.dim[2]-1)&&this.voxels[s+t][l+e][c+n]>0};for(var A=0;A<6;A++)if(r[A]){const r=n[A];for(const n of[0,1,2,2,3,0]){const s=3*r[n],l=3*A;o.push(.5+t[s+0]+u),o.push(.5+t[s+1]+h),o.push(.5+t[s+2]+v),a.push(e[l+0]),a.push(e[l+1]),a.push(e[l+2]);const c=y[A];var d=1;if(A>=0){var E=_(c[g[n][0]]),T=_(c[g[n][1]]),p=_(c[g[n][2]]);E&&p?d=.25:E&&T||p&&T?d=.5:(p||p||T)&&(d=.75)}i.push(f[0]*d),i.push(f[1]*d),i.push(f[2]*d)}}}}console.log(o.length/3);var x=new Float32Array(o),y=new Float32Array(a),g=new Float32Array(i);this.vertexArray=r.createVertexArray(),r.bindVertexArray(this.vertexArray);var _=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,_),r.bufferData(r.ARRAY_BUFFER,x,r.STATIC_DRAW),r.vertexAttribPointer(0,3,r.FLOAT,!1,0,0),r.enableVertexAttribArray(0);var R=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,R),r.bufferData(r.ARRAY_BUFFER,y,r.STATIC_DRAW),r.vertexAttribPointer(1,3,r.FLOAT,!1,0,0),r.enableVertexAttribArray(1);var w=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,w),r.bufferData(r.ARRAY_BUFFER,g,r.STATIC_DRAW),r.vertexAttribPointer(2,3,r.FLOAT,!1,0,0),r.enableVertexAttribArray(2),this.nElements=x.length/3}draw(r){r.bindVertexArray(this.vertexArray),r.drawArrays(r.TRIANGLES,0,this.nElements)}}!function(){var r=document.getElementById("gl-canvas");r.width=window.innerWidth,r.height=window.innerHeight,document.addEventListener("keydown",p,!1),document.addEventListener("keyup",x,!1);var e=r.getContext("webgl2");e||(console.error("WebGL 2 not available"),document.body.innerHTML="This example requires WebGL 2 which is unavailable on this system."),e.clearColor(0,0,0,1);var o=f.trim(),g=e.createShader(e.VERTEX_SHADER);e.shaderSource(g,o),e.compileShader(g),e.getShaderParameter(g,e.COMPILE_STATUS)||console.error(e.getShaderInfoLog(g));var _=m.trim(),R=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(R,_),e.compileShader(R),e.getShaderParameter(R,e.COMPILE_STATUS)||console.error(e.getShaderInfoLog(R));var w=e.createProgram();e.attachShader(w,g),e.attachShader(w,R),e.linkProgram(w),e.getProgramParameter(w,e.LINK_STATUS)||console.error(e.getProgramInfoLog(w)),e.useProgram(w);const D=function(r=Math.random){const t=function(r){const t=new Uint8Array(512);for(let r=0;r<256;r++)t[r]=r;for(let e=0;e<255;e++){const n=e+~~(r()*(256-e)),o=t[e];t[e]=t[n],t[n]=o}for(let r=256;r<512;r++)t[r]=t[r-256];return t}(r),e=new Float64Array(t).map((r=>v[r%12*3])),n=new Float64Array(t).map((r=>v[r%12*3+1])),o=new Float64Array(t).map((r=>v[r%12*3+2]));return function(r,a,i){let s,l,v,f;const m=(r+a+i)*c,A=h(r+m),d=h(a+m),E=h(i+m),T=(A+d+E)*u,p=r-(A-T),x=a-(d-T),y=i-(E-T);let g,_,R,w,D,P;p>=x?x>=y?(g=1,_=0,R=0,w=1,D=1,P=0):p>=y?(g=1,_=0,R=0,w=1,D=0,P=1):(g=0,_=0,R=1,w=1,D=0,P=1):x<y?(g=0,_=0,R=1,w=0,D=1,P=1):p<y?(g=0,_=1,R=0,w=0,D=1,P=1):(g=0,_=1,R=0,w=1,D=1,P=0);const S=p-g+u,M=x-_+u,U=y-R+u,b=p-w+2*u,F=x-D+2*u,L=y-P+2*u,I=p-1+.5,C=x-1+.5,B=y-1+.5,O=255&A,X=255&d,G=255&E;let W=.6-p*p-x*x-y*y;if(W<0)s=0;else{const r=O+t[X+t[G]];W*=W,s=W*W*(e[r]*p+n[r]*x+o[r]*y)}let N=.6-S*S-M*M-U*U;if(N<0)l=0;else{const r=O+g+t[X+_+t[G+R]];N*=N,l=N*N*(e[r]*S+n[r]*M+o[r]*U)}let Y=.6-b*b-F*F-L*L;if(Y<0)v=0;else{const r=O+w+t[X+D+t[G+P]];Y*=Y,v=Y*Y*(e[r]*b+n[r]*F+o[r]*L)}let V=.6-I*I-C*C-B*B;if(V<0)f=0;else{const r=O+1+t[X+1+t[G+1]];V*=V,f=V*V*(e[r]*I+n[r]*C+o[r]*B)}return 32*(s+l+v+f)}}(t()("0")),P=new Array(9);for(var S=-4;S<=4;S++){P[S+4]=new Array(9);for(var M=-4;M<=4;M++){P[S+4][M+4]=new Array(1);for(var U=0;U<=0;U++){const r=new y(i(64,64,64),i(64*S,64*M,64*U));r.init(D),r.createArray(e),P[S+4][M+4][U]=r}}}console.log("generate 3D texture"),e.activeTexture(e.TEXTURE0);var b=e.createTexture();e.bindTexture(e.TEXTURE_3D,b),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_WRAP_R,e.CLAMP_TO_EDGE);var F=new Uint8Array(21233664),L=0;for(U=0;U<64;U++)for(M=0;M<576;M++)for(S=0;S<576;S++){var I=Math.floor(M/64),C=Math.floor(S/64);F[L++]=P[C][I][0].voxels[S%64][M%64][U]}e.texImage3D(e.TEXTURE_3D,0,e.R8UI,576,576,64,0,e.RED_INTEGER,e.UNSIGNED_BYTE,F);var B=e.getUniformLocation(w,"terrainTex");e.uniform1i(B,0);var O=e.getUniformLocation(w,"terrainOffset");e.uniform3fv(O,i(64*Math.floor(P.length/2),64*Math.floor(P.length/2),0));var X=e.getUniformLocation(w,"terrainDim");e.uniform3fv(X,i(64*P.length,64*P.length,64)),console.log(F.length);var G,W,N,Y,V,j,q,H=l();G=H,W=Math.PI/4,N=e.drawingBufferWidth/e.drawingBufferHeight,Y=.1,V=1e3,q=1/Math.tan(W/2),G[0]=q/N,G[1]=0,G[2]=0,G[3]=0,G[4]=0,G[5]=q,G[6]=0,G[7]=0,G[8]=0,G[9]=0,G[11]=-1,G[12]=0,G[13]=0,G[15]=0,null!=V&&V!==1/0?(j=1/(Y-V),G[10]=(V+Y)*j,G[14]=2*V*Y*j):(G[10]=-1,G[14]=-2*Y);var Q=e.getUniformLocation(w,"lightDir"),k=l(),z=l(),K=l(),J=0;const Z=e.getExtension("EXT_disjoint_timer_query_webgl2");var $=Date.now();e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),requestAnimationFrame((function r(){const t=e.createQuery();e.beginQuery(Z.TIME_ELAPSED_EXT,t),J+=.005,"q"==T&&(A+=.01),"d"==T&&(A-=.01),"z"==T&&(d+=.01),"s"==T&&(d-=.01);var o=i(Math.cos(A)*Math.cos(d),Math.sin(A)*Math.cos(d),Math.sin(d));"ArrowUp"==T&&s(E,E,o,.5),"ArrowDown"==T&&s(E,E,o,-.5);var l,c,u,h=a();c=E,u=o,(l=h)[0]=c[0]+u[0],l[1]=c[1]+u[1],l[2]=c[2]+u[2],function(r,t,e,o){var a,i,s,l,c,u,h,v,f,m,A=t[0],d=t[1],E=t[2],T=o[0],p=o[1],x=o[2],y=e[0],g=e[1],_=e[2];Math.abs(A-y)<n&&Math.abs(d-g)<n&&Math.abs(E-_)<n?function(r){r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}(r):(h=A-y,v=d-g,f=E-_,a=p*(f*=m=1/Math.hypot(h,v,f))-x*(v*=m),i=x*(h*=m)-T*f,s=T*v-p*h,(m=Math.hypot(a,i,s))?(a*=m=1/m,i*=m,s*=m):(a=0,i=0,s=0),l=v*s-f*i,c=f*a-h*s,u=h*i-v*a,(m=Math.hypot(l,c,u))?(l*=m=1/m,c*=m,u*=m):(l=0,c=0,u=0),r[0]=a,r[1]=l,r[2]=h,r[3]=0,r[4]=i,r[5]=c,r[6]=v,r[7]=0,r[8]=s,r[9]=u,r[10]=f,r[11]=0,r[12]=-(a*A+i*d+s*E),r[13]=-(l*A+c*d+u*E),r[14]=-(h*A+v*d+f*E),r[15]=1)}(k,E,h=l,i(0,0,1)),function(r,t,e){var n=t[0],o=t[1],a=t[2],i=t[3],s=t[4],l=t[5],c=t[6],u=t[7],h=t[8],v=t[9],f=t[10],m=t[11],A=t[12],d=t[13],E=t[14],T=t[15],p=e[0],x=e[1],y=e[2],g=e[3];r[0]=p*n+x*s+y*h+g*A,r[1]=p*o+x*l+y*v+g*d,r[2]=p*a+x*c+y*f+g*E,r[3]=p*i+x*u+y*m+g*T,p=e[4],x=e[5],y=e[6],g=e[7],r[4]=p*n+x*s+y*h+g*A,r[5]=p*o+x*l+y*v+g*d,r[6]=p*a+x*c+y*f+g*E,r[7]=p*i+x*u+y*m+g*T,p=e[8],x=e[9],y=e[10],g=e[11],r[8]=p*n+x*s+y*h+g*A,r[9]=p*o+x*l+y*v+g*d,r[10]=p*a+x*c+y*f+g*E,r[11]=p*i+x*u+y*m+g*T,p=e[12],x=e[13],y=e[14],g=e[15],r[12]=p*n+x*s+y*h+g*A,r[13]=p*o+x*l+y*v+g*d,r[14]=p*a+x*c+y*f+g*E,r[15]=p*i+x*u+y*m+g*T}(z,H,k);var v=e.getUniformLocation(w,"viewProj");e.uniformMatrix4fv(v,!1,z),function(r,t){var e=Math.sin(t),n=Math.cos(t);r[0]=n,r[1]=e,r[2]=0,r[3]=0,r[4]=-e,r[5]=n,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}(K,J);var f=i(-1,-1,-1);f=function(r,t){var e=t[0],n=t[1],o=t[2],a=e*e+n*n+o*o;return a>0&&(a=1/Math.sqrt(a)),r[0]=t[0]*a,r[1]=t[1]*a,r[2]=t[2]*a,r}(f,f),function(r,t,e){var n=t[0],o=t[1],a=t[2],i=e[3]*n+e[7]*o+e[11]*a+e[15];i=i||1,r[0]=(e[0]*n+e[4]*o+e[8]*a+e[12])/i,r[1]=(e[1]*n+e[5]*o+e[9]*a+e[13])/i,r[2]=(e[2]*n+e[6]*o+e[10]*a+e[14])/i}(f,f,K),e.uniform3fv(Q,f),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);for(var m=-4;m<=4;m++)for(var p=-4;p<=4;p++)for(var x=0;x<=0;x++)P[m+4][p+4][x].draw(e);e.endQuery(Z.TIME_ELAPSED_EXT),Date.now()-$>1e3&&setTimeout((()=>{if(e.getQueryParameter(t,e.QUERY_RESULT_AVAILABLE)){$=Date.now();const r=e.getQueryParameter(t,e.QUERY_RESULT);console.log("rendering time",r/1e6)}}),10),requestAnimationFrame(r)}))}()})()})();